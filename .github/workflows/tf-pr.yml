name: "Terraform PR â€“ full (detect stacks, validate, plan, cost)"

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'terraform/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

# ğŸ”§ í† ê¸€(í•„ìš”ì‹œ true/falseë¡œ ì¡°ì ˆ)
env:
  TF_VERSION: "1.8.5"
  TF_STACK_REGION: ${{ vars.TF_STACK_REGION || 'ap-northeast-2' }}
  RUN_TFLINT: "true"
  RUN_TFSEC: "true"
  RUN_INFRACOST: "true"   # ë¹„ìš© ì½”ë©˜íŠ¸ ì“°ë ¤ë©´ true + secret ì„¤ì •
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY || '' }}

jobs:
  detect:
    name: "ë³€ê²½ëœ ìŠ¤íƒ ê°ì§€"
    runs-on: ubuntu-latest
    outputs:
      stack_dirs: ${{ steps.collect.outputs.stack_dirs }}
      has_changes: ${{ steps.collect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - id: collect
        shell: bash
        run: |
          # 1) ë³€ê²½ íŒŒì¼ ëª©ë¡
          base="${{ github.base_ref }}"
          if [ -z "$base" ]; then base="main"; fi
          CHANGED=$(git diff --name-only origin/$base...HEAD | tr '\n' ' ')
          echo "changed files: $CHANGED"

          # 2) backend.hclì´ ìˆëŠ” ë””ë ‰í„°ë¦¬ë¥¼ 'ìŠ¤íƒ'ìœ¼ë¡œ ê°„ì£¼
          #    (íŒŒì¼ ë³€ê²½ì´ ìŠ¤íƒ ë°–ì— ìˆì–´ë„ ì•ˆì „í•˜ê²Œ ì „ì²´ ê²€ìƒ‰)
          mapfile -t ALL_STACKS < <(find terraform/stacks -name backend.hcl -printf '%h\n' | sort -u)

          # 3) ë³€ê²½ì´ í•´ë‹¹ ìŠ¤íƒ ê²½ë¡œì— í¬í•¨ë˜ë©´ ì„ íƒ
          SELECTED=()
          for sd in "${ALL_STACKS[@]}"; do
            if echo "$CHANGED" | grep -q "$sd/"; then
              SELECTED+=("$sd")
            fi
          done

          # ë³€ê²½ì´ ì—†ìœ¼ë©´ ì „ì²´ ìŠ¤íƒ ìŠ¤í‚µ
          if [ ${#SELECTED[@]} -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "stack_dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi

          printf '%s\n' "${SELECTED[@]}" | jq -R . | jq -s . > /tmp/stack_dirs.json
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "stack_dirs=$(cat /tmp/stack_dirs.json)" >> $GITHUB_OUTPUT
          echo "Stacks:"
          cat /tmp/stack_dirs.json

  plan:
    name: "ê²€ì¦/í”Œëœ/ë¹„ìš©"
    needs: detect
    if: needs.detect.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        stack_dir: ${{ fromJson(needs.detect.outputs.stack_dirs) }}

    steps:
      - uses: actions/checkout@v4

      - name: Terraform ì„¤ì¹˜
        uses: hashicorp/setup-terraform@v3
        with: { terraform_version: ${{ env.TF_VERSION }} }

      - name: ìŠ¤íƒ ê²½ë¡œ/ENV ì¶”ì¶œ
        id: meta
        shell: bash
        run: |
          SD="${{ matrix.stack_dir }}"
          echo "STACK_DIR=$SD" >> $GITHUB_OUTPUT
          # env ì¶”ì¶œ: ê²½ë¡œì— prod/dev ë¬¸ìì—´ì´ í¬í•¨ë˜ë©´ ê·¸ê±¸ ENVë¡œ ì‚¬ìš©
          ENV="dev"
          if [[ "$SD" == *"/prod"* ]] || [[ "$SD" == *"-prod-"* ]]; then ENV="prod"; fi
          echo "ENV=$ENV" >> $GITHUB_OUTPUT
          echo "STACK_DIR=$SD / ENV=$ENV"

      - name: AWS OIDC ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.meta.outputs.ENV == 'prod' && secrets.TF_PROD_ROLE_ARN || secrets.TF_DEV_ROLE_ARN }}
          aws-region: ${{ env.TF_STACK_REGION }}

      - name: fmt
        working-directory: ${{ steps.meta.outputs.STACK_DIR }}
        run: terraform fmt -recursive -check

      - name: init (backend.hcl)
        working-directory: ${{ steps.meta.outputs.STACK_DIR }}
        run: terraform init -backend-config=backend.hcl -reconfigure

      - name: tfvars ì„ íƒ (ENV ìš°ì„ )
        id: tfvars
        working-directory: ${{ steps.meta.outputs.STACK_DIR }}
        shell: bash
        run: |
          F="terraform.tfvars"
          [ -f "${{ steps.meta.outputs.ENV }}.tfvars" ] && F="${{ steps.meta.outputs.ENV }}.tfvars"
          echo "TFVARS=$F" >> $GITHUB_OUTPUT
          echo "Using $F"

      - name: validate
        working-directory: ${{ steps.meta.outputs.STACK_DIR }}
        run: terraform validate

      - name: ì •ì±… ê°€ë“œ(tf_forbidden.sh)
        env:
          ROOT: terraform   # ìŠ¤í¬ë¦½íŠ¸ê°€ terraform/modules, terraform/stacks ê¸°ì¤€ìœ¼ë¡œ ê²€ì‚¬
        run: bash terraform/tools/tf_forbidden.sh

      - name: tflint
        if: env.RUN_TFLINT == 'true'
        run: |
          curl -sSL https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --init
          tflint --recursive ${{ steps.meta.outputs.STACK_DIR }}

      - name: tfsec
        if: env.RUN_TFSEC == 'true'
        uses: aquasecurity/tfsec-action@v1.0.7
        with: { working_directory: ${{ steps.meta.outputs.STACK_DIR }} }

      - name: plan
        id: plan
        working-directory: ${{ steps.meta.outputs.STACK_DIR }}
        run: terraform plan -var-file=${{ steps.tfvars.outputs.TFVARS }} -out=plan.tfplan

      - name: plan artifact ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ steps.meta.outputs.ENV }}-${{ github.sha }}-${{ hashFiles(format('{0}/**', steps.meta.outputs.STACK_DIR)) }}
          path: ${{ steps.meta.outputs.STACK_DIR }}/plan.tfplan

      - name: Infracost(ì½”ë©˜íŠ¸)
        if: env.RUN_INFRACOST == 'true' && env.INFRACOST_API_KEY != ''
        uses: infracost/actions/inline@v3
        with:
          path: .
          working-directory: ${{ steps.meta.outputs.STACK_DIR }}
          api-key: ${{ env.INFRACOST_API_KEY }}
          post-condition: always()

      - name: PR ì½”ë©˜íŠ¸(ìŠ¤íƒë³„)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: plan-${{ steps.meta.outputs.STACK_DIR }}
          recreate: true
          message: |
            ### Terraform plan â€“ `${{ steps.meta.outputs.STACK_DIR }}`
            - ENV: `${{ steps.meta.outputs.ENV }}`
            - tfvars: `${{ steps.tfvars.outputs.TFVARS }}`
            - region: `${{ env.TF_STACK_REGION }}`
            - plan artifact ì—…ë¡œë“œ ì™„ë£Œ âœ…

  no-change:
    if: needs.detect.outputs.has_changes != 'true'
    runs-on: ubuntu-latest
    steps:
      - run: echo "â„¹ï¸ Terraform ë³€ê²½ ì—†ìŒ â†’ ê²€ì¦/í”Œëœ ìƒëµ"
